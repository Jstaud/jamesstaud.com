name: Deploy Infrastructure and Application
on:
  push:
    branches:
      - initial-app
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Convert repository name to lowercase
        id: repo
        run: | 
          REPO_NAME="${{ github.repository }}"
          REPO_NAME="${REPO_NAME#*/}"
          echo "::set-output name=repo::$(echo $REPO_NAME | awk '{print tolower($0)}')"
      
      - name: Build the Docker images
        run: |
          docker build . --file ./backend/dockerfile --tag ${{ steps.repo.outputs.repo }}-backend:latest
          docker build . --file ./frontend/dockerfile --tag ${{ steps.repo.outputs.repo }}-frontend:latest

      - name: Run the Docker containers
        run: |
          docker run -d -p 8000:8000 --env-file .env ${{ steps.repo.outputs.repo }}-backend:latest
          docker run -d -p 8080:8080 --env-file .env -e BACKEND_API_URL=http://localhost:8000/query ${{ steps.repo.outputs.repo }}-frontend:latest

      - name: Push the Docker images to GHCR
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker tag ${{ steps.repo.outputs.repo }}-backend:latest ghcr.io/${{ github.repository }}/${{ steps.repo.outputs.repo }}-backend:latest
          docker tag ${{ steps.repo.outputs.repo }}-frontend:latest ghcr.io/${{ github.repository }}/${{ steps.repo.outputs.repo }}-frontend:latest
          docker push ghcr.io/${{ github.repository }}/${{ steps.repo.outputs.repo }}-backend:latest
          docker push ghcr.io/${{ github.repository }}/${{ steps.repo.outputs.repo }}-frontend:latest

      - name: Deploy backend to DigitalOcean App Platform
        uses: digitalocean/app_action@v1.1.5
        with:
          app_name: ${{ steps.repo.outputs.repo }}-backend
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Deploy frontend to DigitalOcean App Platform
        uses: digitalocean/app_action@v1.1.5
        with:
          app_name: ${{ steps.repo.outputs.repo }}-frontend
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
